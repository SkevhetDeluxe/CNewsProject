@using CNewsProject.StaticTempData
@using Stripe
@model NLUserSetting
}

<div>
    @{
        // Vars and Setup

        int count = 1;
        List<string> authorNames = new();
        List<string> subscribedTo = new();

        var dynAuthorList = ViewBag.authorList;
        foreach (var item in dynAuthorList)
        {
            authorNames.Add(item);
        }

        var dynSubscribedTo = ViewBag.subscribedTo;
        foreach (var item in dynSubscribedTo)
        {
            subscribedTo.Add(item);
        }

        SearchBarSetting authorSearchSetting = new(authorNames, "author", "AddAuthorToSubscribed", "Author", "Add");
    }

    <h5 id="personalisedSettingsHitBox" class="c-hover-pointer c-nonselectable">Personalised News Letter</h5>

    <div id="personalisedSettingsTarget" class="c-hidden">
        <div class="row">
            <form asp-action="UpdateNewsLetterSetting" method="post">

                <div>
                    <label class="col-9" asp-for="Latest">Include Latest News</label>
                    <input class="offset-1 col-1" asp-for="Latest"></input><br/>
                </div>
                <div>
                    <label class="col-9" asp-for="Popular">Include Popular News</label>
                    <input class="offset-1 col-1" asp-for="Popular"></input><br/>
                </div>

                <div>
                    <h6 style="font-weight: bold">
                        Included Categories
                    </h6>
                </div>
                <input asp-for="CategoryIds"></input>
                <input name="authorNames" type="hidden"/>

                <div id="authorNamesHitBox" class="c-hover-pointer c-nonselectable">
                    <h4 style="font-weight: bold;">Subscribed Authors</h4>
                </div>
                <div id="authorNamesTarget">
                    <partial name="_searchBarWithSuggestionsPartial" model="authorSearchSetting"/>
                    <div id="authorNamesContainer" class="col-9">
                    </div>
                </div>

                <br/>
                <button class="btn btn-primary">Update</button>
            </form>
        </div>
    </div>
</div>


<script src="/js/cscripts.js"></script>
<script type="text/javascript">
    
    AddToggleableElementId("personalisedSettingsHitBox","personalisedSettingsTarget");
    AddToggleableElementId("authorNamesHitBox","authorNamesTarget");
        
    document.addEventListener("DOMContentLoaded", function () {
        const inputBox = document.getElementById('@authorSearchSetting.InputFieldId');
        const inputButton = document.getElementById('@authorSearchSetting.ButtonId');
        
        let subscribedAuthors = @Html.Raw(Json.Serialize(@subscribedTo));
        let lastOddOrEven = 1;
        if (subscribedAuthors[0] !== "NO!"){
            lastOddOrEven = CreateAuthorDivs("authorNamesContainer", subscribedAuthors, 1);
        }

        inputBox.addEventListener('keydown', function (e) {
            if (e.key === "Enter") {
                AddAuthorToSubscribed(inputBox);
            }
        });
        
        inputButton.addEventListener('click', function (){
            AddAuthorToSubscribed(inputBox);
        });

        function AddAuthorToSubscribed(inputElement){

            let inputValue = inputElement.value;

            if (arrayContains(@{@authorSearchSetting.JsArrayName}, inputValue)){
                @{@authorSearchSetting.JsArrayName} = @{@authorSearchSetting.JsArrayName}.filter(function (val) {
                    return val !== inputValue;
                });
                
                lastOddOrEven = CreateSingleAuthorDiv("authorNamesContainer", inputValue, lastOddOrEven);
                document.getElementById('@authorSearchSetting.InputFieldId').innerHTML = "";
            }
        }
    });
</script>