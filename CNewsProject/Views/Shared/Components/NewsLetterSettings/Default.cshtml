@using CNewsProject.StaticTempData
@using Stripe
@model NLUserSetting

<div>
    @{
        // Vars and Setup

        List<string> authorNames = new();
        List<string> subscribedTo = new();

        var dynAuthorList = ViewBag.authorList;
        foreach (var item in dynAuthorList)
        {
            authorNames.Add(item);
        }

        var dynSubscribedTo = ViewBag.subscribedTo;
        foreach (var item in dynSubscribedTo)
        {
            subscribedTo.Add(item);
        }

        SearchBarSetting authorSearchSetting = new(authorNames, "author", "AddAuthorToSubscribed", "Author", "Add");
    }

    <h5 id="personalisedSettingsHitBox" class="c-hover-pointer c-nonselectable">Personalised News Letter</h5>

    <div id="personalisedSettingsTarget" class="c-hidden">
        <div class="row">
            <form id="newsLetterSettingsForm" asp-action="UpdateNewsLetterSetting" method="post">
                
                <div>
                    Enable Newsletter?
                    @{
                        if (Model.NewsLetterEnabled)
                        {
                            <input name="NewsLetterEnabled" checked="checked" type="checkbox" value="true"/>
                        }
                        else
                        {
                            <input name="NewsLetterEnabled" type="checkbox" value="true"/>
                        }
                    }
                    
                </div>
                
                <div>
                    <label class="col-9" asp-for="Latest">Include Latest News</label>
                    @{
                        if (Model.Latest)
                        {
                            <input class="offset-1 col-1" name="Latest" type="checkbox" checked="checked" value="true"/>
                        }
                        else
                        {
                            <input class="offset-1 col-1" name="Latest" type="checkbox" value="true"/>
                        }
                    }
                </div>
                <div>
                    <label class="col-2" asp-for="Popular">Include Popular News</label>
                    @{
                        if (Model.Popular)
                        {
                            <input class="offset-1 col-1" name="Popular" type="checkbox" checked="checked" value="true"/>
                        }
                        else
                        {
                            <input class="offset-1 col-1" name="Popular" type="checkbox" value="true"/>
                        }
                    }
                </div>

                <div>
                    <h6 style="font-weight: bold">
                        Included Categories
                    </h6>
                </div>

                <input id="categoryIdsInput" type="hidden" asp-for="CategoryIds" value=""/>
                <div class="row">
                @{
                    Dictionary<string, int> makeShitHappen = new() { { "Local", 1 }, { "Economy", 2 }, { "Sport", 3 }, { "Sweden", 4 }, { "World", 5 } };
                    foreach (KeyValuePair<string, int> kvp in makeShitHappen)
                    {
                        if (Model.CategoryIds.Contains(kvp.Value))
                        {
                            <label class="col-9">@kvp.Key</label><input type="checkbox" checked="checked" class="ThisClassIsPurelyForCategoryIds col-1 offset-1" value="@kvp.Value"/>
                        }
                        else
                        {
                            <label class="col-9">@kvp.Key</label><input type="checkbox" class="ThisClassIsPurelyForCategoryIds col-1 offset-1" value="@kvp.Value"/>
                        }
                    }
                }
                </div>
                <div id="authorNamesHitBox" class="c-hover-pointer c-nonselectable">
                    <h4 style="font-weight: bold;">Subscribed Authors</h4>
                </div>
                <div id="authorNamesTarget">
                    <partial name="_searchBarWithSuggestionsPartial" model="authorSearchSetting"/>
                    <div id="authorNamesContainer" class="col-9">
                    </div>
                    <input type="hidden" id="returnToAuthorArray"/>
                </div>

                <br/>
                <button id="updateNewsLetterButton" class="btn btn-primary">Update</button>
            </form>
        </div>
    </div>
</div>


<script src="/js/cscripts.js"></script>
<script type="text/javascript">
    
    AddToggleableElementId("personalisedSettingsHitBox","personalisedSettingsTarget");
    AddToggleableElementId("authorNamesHitBox","authorNamesTarget");
        
    document.addEventListener("DOMContentLoaded", function () {
    
        const inputBox = document.getElementById('@authorSearchSetting.InputFieldId');
        const inputButton = document.getElementById('@authorSearchSetting.ButtonId');
        const returnToArray = document.getElementById('returnToAuthorArray');
        const form = document.getElementById("newsLetterSettingsForm");
            
        let subscribedAuthors = @Html.Raw(Json.Serialize(@subscribedTo));
        let lastOddOrEven = 1;
        if (subscribedAuthors[0] !== "NO!"){
            lastOddOrEven = CreateAuthorDivs("authorNamesContainer", subscribedAuthors);
        }
        
        form.addEventListener('submit', function (event){
            event.preventDefault();
            
            let catIdsArr=[];
            document.querySelectorAll(".ThisClassIsPurelyForCategoryIds:checked").forEach(function (elem){
                catIdsArr.push(elem.value);
            });
               
            document.getElementById("categoryIdsInput").value = StringifyArrayValues(catIdsArr);
            
            
            let AuthorValues = GetAuthorDivValues();
            if (AuthorValues !== "NO AUTHORS"){
                console.log(AuthorValues);
            }
            
            const data = new FormData(event.target);
            const formJSON = Object.fromEntries(data.entries());
            
            console.log(formJSON);
            
            AjaxUpdateNewsLetterSetting(formJSON, AuthorValues);
        });
        
        returnToArray.addEventListener('JSValueChange', function(){
            @{@authorSearchSetting.JsArrayName}.push(this.value);
        });

        inputBox.addEventListener('keydown', function (e) {
            if (e.key === "Enter") {
                AddAuthorToSubscribed(inputBox);
            }
        });
        
        inputButton.addEventListener('click', function (){
            AddAuthorToSubscribed(inputBox);
        });

        function AddAuthorToSubscribed(inputElement){
            
            let stefansMindBeAtEase = document.getElementById("authorNamesContainer").getElementsByTagName("input")[0];
            if (stefansMindBeAtEase === undefined){lastOddOrEven = 1;}
            
            let inputValue = inputElement.value;

            if (arrayContains(@{@authorSearchSetting.JsArrayName}, inputValue)){
                @{@authorSearchSetting.JsArrayName} = @{@authorSearchSetting.JsArrayName}.filter(function (val) {
                    return val !== inputValue;
                });
                
                lastOddOrEven = CreateSingleAuthorDiv("authorNamesContainer", inputValue);
                document.getElementById('@authorSearchSetting.InputFieldId').innerHTML = "";
            }
        }
    });
</script>